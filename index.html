<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="theme-color" content="#f97316" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="CuisineDuo" />
    <title>CuisineDuo</title>
  </head>
  <body>
    <div id="root">
      <!-- Loading fallback visible avant que React ne monte â€” evite l'ecran blanc -->
      <div id="app-loader" style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f9fafb;font-family:system-ui,sans-serif;">
        <div style="width:48px;height:48px;border:4px solid #fed7aa;border-top-color:#f97316;border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:16px;"></div>
        <p style="color:#9ca3af;font-size:14px;">CuisineDuo</p>
      </div>
      <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
    </div>
    <!-- Detecter les erreurs de chargement de module (assets perimes apres deploiement) -->
    <script>
      window.addEventListener('error', function(e) {
        // Detecter "Failed to load module script" ou erreur de syntaxe sur un module HTML
        if (e.message && (e.message.includes('module') || e.message.includes('Module') || e.message.includes('MIME'))) {
          handleStaleAssets();
        }
      });
      // Aussi intercepter les erreurs de chargement de <script type="module">
      window.addEventListener('unhandledrejection', function(e) {
        if (e.reason && (String(e.reason).includes('Failed to fetch') || String(e.reason).includes('module'))) {
          handleStaleAssets();
        }
      });
      function handleStaleAssets() {
        if (sessionStorage.getItem('reload_attempted')) return; // Eviter boucle infinie
        sessionStorage.setItem('reload_attempted', '1');
        // Vider tous les caches Service Worker
        if ('caches' in window) {
          caches.keys().then(function(names) {
            return Promise.all(names.map(function(n) { return caches.delete(n); }));
          }).then(function() {
            // Desinscrire le SW
            if ('serviceWorker' in navigator) {
              navigator.serviceWorker.getRegistrations().then(function(regs) {
                return Promise.all(regs.map(function(r) { return r.unregister(); }));
              }).then(function() { window.location.reload(); });
            } else {
              window.location.reload();
            }
          });
        } else {
          window.location.reload();
        }
      }
      // Nettoyer le flag apres un chargement reussi
      window.addEventListener('load', function() {
        setTimeout(function() { sessionStorage.removeItem('reload_attempted'); }, 3000);
      });
    </script>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
