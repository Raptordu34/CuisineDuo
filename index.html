<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="theme-color" content="#f97316" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="CuisineDuo" />
    <title>CuisineDuo</title>
  </head>
  <body>
    <div id="root">
      <!-- Loading fallback visible avant que React ne monte — evite l'ecran blanc -->
      <div id="app-loader" style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f9fafb;font-family:system-ui,sans-serif;">
        <div style="width:48px;height:48px;border:4px solid #fed7aa;border-top-color:#f97316;border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:16px;"></div>
        <p style="color:#9ca3af;font-size:14px;">CuisineDuo</p>
      </div>
      <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
    </div>
    <!-- Detecter les erreurs de chargement de module (assets perimes apres deploiement) -->
    <script>
      var _reloadAttempted = false;
      function handleStaleAssets() {
        if (_reloadAttempted) return;
        if (sessionStorage.getItem('reload_attempted')) return; // Eviter boucle infinie
        _reloadAttempted = true;
        sessionStorage.setItem('reload_attempted', '1');
        console.warn('[Recovery] Stale assets detected — clearing caches and reloading...');
        // Vider tous les caches Service Worker
        var p = Promise.resolve();
        if ('caches' in window) {
          p = caches.keys().then(function(names) {
            return Promise.all(names.map(function(n) { return caches.delete(n); }));
          });
        }
        p.then(function() {
          if ('serviceWorker' in navigator) {
            return navigator.serviceWorker.getRegistrations().then(function(regs) {
              return Promise.all(regs.map(function(r) { return r.unregister(); }));
            });
          }
        }).then(function() {
          // Forcer le bypass du cache HTTP du navigateur avec un query param unique
          var url = window.location.origin + window.location.pathname + '?_=' + Date.now();
          window.location.replace(url);
        }).catch(function() {
          window.location.replace(window.location.origin + '/?_=' + Date.now());
        });
      }
      // Phase de CAPTURE : intercepte les erreurs de chargement de <script>, <link>, etc.
      window.addEventListener('error', function(e) {
        var el = e.target;
        if (el && (el.tagName === 'SCRIPT' || el.tagName === 'LINK')) {
          handleStaleAssets();
        }
      }, true);
      // Aussi intercepter les erreurs JS classiques mentionnant MIME ou module
      window.addEventListener('error', function(e) {
        if (e.message && (e.message.includes('MIME') || e.message.includes('module') || e.message.includes('Module'))) {
          handleStaleAssets();
        }
      });
      window.addEventListener('unhandledrejection', function(e) {
        var reason = e.reason ? String(e.reason) : '';
        if (reason.includes('Failed to fetch') || reason.includes('module') || reason.includes('MIME') || reason.includes('dynamically imported')) {
          handleStaleAssets();
        }
      });
      // Nettoyer le flag apres un chargement reussi, SEULEMENT si React a monté
      window.addEventListener('load', function() {
        setTimeout(function() {
          var root = document.getElementById('root');
          if (root && root.children.length > 2) {
             sessionStorage.removeItem('reload_attempted');
          }
        }, 3000);
      });
      // Securite : si apres 8s le root est toujours vide (React n'a pas monte), forcer le rechargement
      setTimeout(function() {
        var root = document.getElementById('root');
        var loader = document.getElementById('app-loader');
        if (root && loader && root.children.length <= 2) {
          // Le loader est toujours la, React n'a pas monte — potentiellement JS pas charge
          if (!sessionStorage.getItem('reload_attempted')) {
            handleStaleAssets();
          } else {
            loader.innerHTML += '<p style="color:red;margin-top:10px;text-align:center;padding:0 20px;">Erreur de chargement.<br>Veuillez vider le cache de votre navigateur.</p>';
          }
        }
      }, 8000);
    </script>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
